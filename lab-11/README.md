# Lab 11: Flyway Database Migrations
In this lab we change from the hibernate-autogenerated ddl to database migration using [flyway db](https://flywaydb.org/).

After completing this lab you should know how to configure flyway in spring boot and provide ddl schema scripts to
 migrate the db schema inside the in-memory H2 database.

## Initial code

There _initial_ project contains the spring boot application from previous lab plus the additional dependency
for flyway db library. 

In the _complete_ project you find the spring boot project containing the data access layer with following classes/files:

* CompleteApplication: This is the generated starter class to start the spring boot application (contains a main() method).
* DataInitializer: A spring boot command line helper class to store some test data in the database at application start.
* PersonService: A spring service defining the transactional boundaries for data access layer
* PersonRepository: The data access repository for *Person* and *Address* entity data
* Entities:
    * Person: Persistent *Person* entity
    * Address: Persistent *Address* entity
    * Country: An enum for countries (used in *Address*)
* V01_InitialSchema.sql: The flyway db migration script (executed automatically at application start)
* application.yml: Externalized (default) configuration for the application in YAML format
 
## Steps to complete

1. Start the initial application.
You should see sql statements for creating/altering tables and constraints in the console log.
Select all these statements and copy these into the already existing file *V01_InitialSchema.sql* 
(pay attention that you do NOT copy any SELECT statements).

    These statements should look something like this:

    ```
        Hibernate: create table address(...)
        Hibernate: create table person(...)
        Hibernate: create table person_addresses(...)    
        Hibernate: alter table address drop constraint...
        ...
    ```
    
2. Now remove the following line from *application.yml* (this did the auto-generation for ddl so far) or set it to *false*:

    `generate-ddl: true`
    
    After doing this restart the application, then flyway takes over database migration instead of the hibernate auto-generation.
    
3. Now let us look again into the in-memory database using the h2 console. To perform this just browse to 
[localhost:8080/h2-console](http://localhost:8080/h2-console). Make sure that the following settings are in the login dialog:

    * Driver Class: org.h2.Driver
    * JDBC-URL: jdbc:h2:mem:testdb
    * User Name: sa
    * Password: 
    
    Now you will notice an additional table *flyway_schema_history*. This table is used by flyway to check the db schema versio
    and if there is any further db schema script to be executed. 
         
***Tip:***
If you need any help then consult the [presentation](https://andifalk.github.io/spring-basics-training/presentation/index.html) 
or the [Spring Boot Reference Docs](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-execute-flyway-database-migrations-on-startup)
or the [Flyway DB Docs](https://flywaydb.org/documentation/). 
If you really have no clue you can always look into the finished reference code in _complete_ sub project
